parameters:
  log_folder_name: ''
  language: ''

steps:
- powershell: $(Horton.FrameworkRoot)/scripts/remove-edgehub-device.ps1
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'POWERSHELL: remove devices'
  condition: and(always(), ne(variables['skipTest'],'yes'))

- script: |
    $(Horton.FrameworkRoot)/scripts/fetch-logs.sh ${{ parameters.language }}
    mkdir -p $(Build.SourcesDirectory)/results/${{ parameters.log_folder_name }}
    mv $(Horton.FrameworkRoot)/results/logs/* $(Build.SourcesDirectory)/results/${{ parameters.log_folder_name }}/
    mv $(Build.SourcesDirectory)/TEST-* $(Build.SourcesDirectory)/results
  displayName: 'Fetch logs'
  condition: and(always(), ne(variables['skipTest'],'yes'))

- task: PublishTestResults@2
  displayName: 'Publish Test Results **/TEST-*.xml'
  condition: and(always(), ne(variables['skipTest'],'yes'))

- task: CopyFiles@2
  displayName: 'Copy result files to artifact staging'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)/results'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  condition: and(always(), ne(variables['skipTest'],'yes'))

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact'
  inputs:
    pathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Result for $(Build.DefinitionName) $(Build.BuildId)'
  condition: and(always(), ne(variables['skipTest'],'yes'))


